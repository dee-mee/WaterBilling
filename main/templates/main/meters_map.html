{% extends 'main/layout.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Meters Map</h1>
        <div class="btn-group" role="group">
            <a href="{% url 'meters_map' %}?filter=all" 
               class="btn btn-sm {% if filter_type == 'all' %}btn-primary{% else %}btn-secondary{% endif %}">
                All Meters ({{ total_meters }})
            </a>
            <a href="{% url 'meters_map' %}?filter=active" 
               class="btn btn-sm {% if filter_type == 'active' %}btn-primary{% else %}btn-secondary{% endif %}">
                Active ({{ active_count }})
            </a>
            <a href="{% url 'meters_map' %}?filter=inactive" 
               class="btn btn-sm {% if filter_type == 'inactive' %}btn-primary{% else %}btn-secondary{% endif %}">
                Inactive ({{ inactive_count }})
            </a>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Meter Locations</h6>
        </div>
        <div class="card-body">
            <div id="map" style="height: 600px; width: 100%;"></div>
        </div>
    </div>

    <!-- Meter Details Modal -->
    <div class="modal fade" id="meterDetailsModal" tabindex="-1" role="dialog" aria-labelledby="meterDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="meterDetailsModalLabel">Meter Details</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="meterDetailsContent">
                    <!-- Details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
    // Meter data from Django
    // Use JSON.parse to avoid template output confusing JS parsers and to ensure valid JSON at runtime.
    var metersData = JSON.parse('{{ meters_data|escapejs }}');

    // Color based on status
    function getMarkerColor(status) {
        if (status === 'Connected') {
            return 'green';
        } else if (status === 'Disconnected') {
            return 'red';
        } else {
            return 'orange';
        }
    }

    // Icon based on status
    function createCustomIcon(status) {
        var color = getMarkerColor(status);
        return L.divIcon({
            className: 'custom-marker',
            html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });
    }

    function initMetersMap() {
        var mapEl = document.getElementById('map');
        if (!mapEl) {
            console.error('Map element not found');
            return;
        }
        
        if (typeof L === 'undefined') {
            console.error('Leaflet (L) not loaded');
            return;
        }

        // Ensure map container is visible and has dimensions
        var rect = mapEl.getBoundingClientRect();
        if (rect.width === 0 || rect.height === 0) {
            console.warn('Map container has no dimensions, retrying...');
            setTimeout(initMetersMap, 100);
            return;
        }

        // Initialize map - Centered on Kenya, zoomed to show only Kenya
        // Kenya bounds: North: 5.5°N, South: -4.7°S, East: 41.9°E, West: 33.9°E
        var map = L.map('map', {
            zoomControl: true,
            preferCanvas: false,
            fadeAnimation: true,
            zoomAnimation: true
        });
        
        // Set view to Kenya with appropriate zoom level (6.5 shows Kenya nicely)
        map.setView([0.4, 37.9], 6.5);
        
        // Set max bounds to keep map focused on Kenya/East Africa region
        var kenyaBounds = L.latLngBounds(
            [-5.0, 33.0],  // Southwest corner
            [6.0, 42.5]    // Northeast corner
        );
        map.setMaxBounds(kenyaBounds);

        // Multiple tile layer options for better reliability
        // Primary: OpenStreetMap France (more reliable for production)
        var osmFr = L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 20,
            subdomains: 'abc',
            crossOrigin: true
        });

        // Fallback 1: CartoDB (reliable CDN)
        var carto = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20,
            crossOrigin: true
        });

        // Fallback 2: OpenStreetMap standard (last resort)
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19,
            crossOrigin: true
        });

        var currentLayer = null;
        var currentLayerIndex = 0;
        var tileLayers = [osmFr, carto, osm];
        var layerNames = ['OSM France', 'CartoDB', 'OpenStreetMap'];
        var tileErrorCounts = [0, 0, 0];
        var maxTileErrors = 3;

        // Function to switch to next fallback layer
        function switchToNextLayer() {
            if (currentLayerIndex >= tileLayers.length - 1) {
                console.error('All tile layers failed, map may not display correctly');
                return;
            }
            
            var oldLayer = currentLayer;
            currentLayerIndex++;
            currentLayer = tileLayers[currentLayerIndex];
            
            console.warn('Switching to fallback tile layer: ' + layerNames[currentLayerIndex]);
            try {
                if (oldLayer) {
                    map.removeLayer(oldLayer);
                }
            } catch (err) {
                console.warn('Error removing layer:', err);
            }
            
            currentLayer.addTo(map);
            tileErrorCounts[currentLayerIndex] = 0;
        }

        // Enhanced error handling for each layer
        tileLayers.forEach(function(layer, index) {
            layer.on('tileerror', function(e) {
                if (currentLayerIndex === index) {
                    tileErrorCounts[index]++;
                    console.warn(layerNames[index] + ' tile error (' + tileErrorCounts[index] + ')', e);
                    if (tileErrorCounts[index] >= maxTileErrors) {
                        switchToNextLayer();
                    }
                }
            });
            
            // Reset error count on successful tile load
            layer.on('tileload', function() {
                if (currentLayerIndex === index && tileErrorCounts[index] > 0) {
                    tileErrorCounts[index] = Math.max(0, tileErrorCounts[index] - 1);
                }
            });
        });

        // Track if any tiles have loaded successfully
        var tilesLoadedSuccessfully = false;
        var tileLoadTimeout = null;
        
        osmFr.on('tileload', function() {
            tilesLoadedSuccessfully = true;
            if (tileLoadTimeout) {
                clearTimeout(tileLoadTimeout);
                tileLoadTimeout = null;
            }
        });
        
        // Start with primary layer
        currentLayer = osmFr;
        osmFr.addTo(map);
        
        // If tiles don't load within 5 seconds, try fallback
        tileLoadTimeout = setTimeout(function() {
            if (currentLayerIndex === 0 && !tilesLoadedSuccessfully) {
                console.warn('Tiles not loading within timeout, switching to fallback');
                switchToNextLayer();
            }
        }, 5000);

        // Add markers to map
        var markers = [];
        metersData.forEach(function(meter) {
            var marker = L.marker([meter.latitude, meter.longitude], {
                icon: createCustomIcon(meter.status)
            }).addTo(map);

            var popupContent = `
                <div style="min-width: 200px;">
                    <h6><strong>Meter #${meter.meter_number}</strong></h6>
                    <p><strong>Customer:</strong> ${meter.name}</p>
                    <p><strong>Status:</strong> <span class="badge badge-${meter.status === 'Connected' ? 'success' : meter.status === 'Disconnected' ? 'danger' : 'warning'}">${meter.status}</span></p>
                    <p><strong>Address:</strong> ${meter.address}</p>
                    <p><strong>Contact:</strong> ${meter.contact_number}</p>
                    <p><strong>Total Consumption:</strong> ${meter.total_consumption} m³</p>
                    <button class="btn btn-sm btn-primary mt-2" onclick="showMeterDetails(${meter.id})">View Details</button>
                </div>
            `;

            marker.bindPopup(popupContent);
            marker.meterData = meter;
            markers.push(marker);

            marker.on('click', function() {
                showMeterDetails(meter.id);
            });
        });

        if (markers.length > 0) {
            var group = new L.featureGroup(markers);
            var bounds = group.getBounds();
            var boundsSize = bounds.getNorthEast().distanceTo(bounds.getSouthWest());
            
            // Only fit bounds if markers are spread out (more than 50km apart)
            // Otherwise, keep the initial view showing all of Kenya
            if (boundsSize > 50000) { // 50km in meters
                map.fitBounds(bounds.pad(0.1), {
                    maxZoom: 7 // Don't zoom in more than level 7
                });
            }
        }

        // On some layouts (esp. when fonts/CSS load late), Leaflet needs a resize tick
        setTimeout(function() {
            map.invalidateSize();
        }, 0);
        setTimeout(function() {
            map.invalidateSize();
        }, 250);

        // Make map available for debugging
        window._metersMap = map;
    }

    // Function to show meter details in modal
    function showMeterDetails(meterId) {
        var meter = metersData.find(m => m.id === meterId);
        if (!meter) return;

        var detailsHtml = `
            <table class="table table-bordered">
                <tr>
                    <th>Meter Number</th>
                    <td>${meter.meter_number}</td>
                </tr>
                <tr>
                    <th>Customer Name</th>
                    <td>${meter.name}</td>
                </tr>
                <tr>
                    <th>Status</th>
                    <td><span class="badge badge-${meter.status === 'Connected' ? 'success' : meter.status === 'Disconnected' ? 'danger' : 'warning'}">${meter.status}</span></td>
                </tr>
                <tr>
                    <th>Address</th>
                    <td>${meter.address}</td>
                </tr>
                <tr>
                    <th>Contact Number</th>
                    <td>${meter.contact_number}</td>
                </tr>
                <tr>
                    <th>Total Consumption</th>
                    <td>${meter.total_consumption} m³</td>
                </tr>
                <tr>
                    <th>Location</th>
                    <td>Lat: ${meter.latitude}, Lng: ${meter.longitude}</td>
                </tr>
            </table>
        `;

        document.getElementById('meterDetailsContent').innerHTML = detailsHtml;
        $('#meterDetailsModal').modal('show');
    }

    window.showMeterDetails = showMeterDetails;

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMetersMap);
    } else {
        initMetersMap();
    }
</script>

<style>
    .custom-marker {
        background: transparent;
        border: none;
    }

    #map {
        height: 600px !important;
        width: 100% !important;
        position: relative;
        z-index: 0;
    }

    .leaflet-container {
        height: 100%;
        width: 100%;
        background-color: #e5e3df;
    }

    .leaflet-container img {
        max-width: none !important;
        max-height: none !important;
    }

    .leaflet-tile {
        max-width: none !important;
        max-height: none !important;
        visibility: visible !important;
    }

    .leaflet-tile,
    .leaflet-tile-loaded {
        opacity: 1 !important;
        visibility: visible !important;
        display: block !important;
    }

    .leaflet-tile-container {
        visibility: visible !important;
    }

    .leaflet-pane.leaflet-tile-pane {
        z-index: 200 !important;
    }

    .leaflet-tile-pane {
        opacity: 1 !important;
    }

    /* Fix for production environments where tiles might not load */
    .leaflet-container .leaflet-tile-pane img {
        pointer-events: auto !important;
    }
</style>
{% endblock %}
