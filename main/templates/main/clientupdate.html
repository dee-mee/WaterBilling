{% extends 'main/layout.html' %}
{% load static %}

{% block body %}

<div class="container"> 
    <h1 class="h3 mb-2 text-primary text-center font-weight-bolder">Update {{ client }}</h1><br>
<form action="" method="POST" class="user" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="form-group mt-3">
        <label>Meter Number: </label> <br>
        {{ form.meter_number }}
    </div>
    <div class="form-group mt-3">
        <label>First Name: </label> <br>
        {{ form.first_name }}
    </div>
    <div class="form-group mt-3">
        <label>Middle Name: </label> <br>
        {{ form.middle_name }}
    </div>
    <div class="form-group mt-3">
        <label>Last Name: </label> <br>
        {{ form.last_name }}
    </div>
    <div class="form-group mt-3">
        <label>Contact Number: </label> <br>
        {{ form.contact_number }}
    </div>
    <div class="form-group mt-3">
        <label>Address: </label> <br>
        {{ form.address }}
    </div>
    <div class="form-group mt-3">
        <label>Location (Click on map to set coordinates):</label>
        <div id="locationMap" style="height: 300px; width: 100%; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;"></div>
        <div class="row">
            <div class="col-md-6">
                <label for="{{ form.latitude.id_for_label }}">Latitude:</label>
                {{ form.latitude }}
            </div>
            <div class="col-md-6">
                <label for="{{ form.longitude.id_for_label }}">Longitude:</label>
                {{ form.longitude }}
            </div>
        </div>
        <small class="form-text text-muted">Click on the map above to set the meter location, or enter coordinates manually.</small>
    </div>
    <div class="form-group mt-3">
        <label>Connection Status: </label> <br>
        {{ form.status }}
    </div>


   <div class="d-flex justify-content-center">
   <input type="submit" value="Save" class="btn btn-primary btn-user  w-25">
   <a href="{{request.META.HTTP_REFERER}}" class="ml-3 btn btn-secondary btn-user  w-25">Cancel</a>
   </div>
</form>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
$(document).ready(function() {
    // Initialize map for location picker - Default to Kenya (Nairobi)
    var locationMap = L.map('locationMap').setView([-1.2921, 36.8219], 10);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(locationMap);
    
    // Get initial coordinates from form fields
    var latField = $('#id_latitude');
    var lngField = $('#id_longitude');
    var initialLat = parseFloat(latField.val()) || -1.2921;
    var initialLng = parseFloat(lngField.val()) || 36.8219;
    
    // Create marker
    var marker = L.marker([initialLat, initialLng], {draggable: true}).addTo(locationMap);
    
    // Update form fields when marker is moved
    marker.on('dragend', function(e) {
        var position = marker.getLatLng();
        latField.val(position.lat.toFixed(6));
        lngField.val(position.lng.toFixed(6));
    });
    
    // Update marker position when map is clicked
    locationMap.on('click', function(e) {
        var lat = e.latlng.lat;
        var lng = e.latlng.lng;
        marker.setLatLng([lat, lng]);
        latField.val(lat.toFixed(6));
        lngField.val(lng.toFixed(6));
    });
    
    // Update marker when coordinates are manually entered
    latField.add(lngField).on('change', function() {
        var lat = parseFloat(latField.val());
        var lng = parseFloat(lngField.val());
        if (!isNaN(lat) && !isNaN(lng)) {
            marker.setLatLng([lat, lng]);
            locationMap.setView([lat, lng], locationMap.getZoom());
        }
    });
    
    // Set initial marker position if coordinates exist
    if (latField.val() && lngField.val()) {
        locationMap.setView([initialLat, initialLng], 15);
    }
});
</script>

{% endblock %}